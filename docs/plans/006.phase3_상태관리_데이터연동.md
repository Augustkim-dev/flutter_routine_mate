# 006. Phase 3: ìƒíƒœ ê´€ë¦¬ ë° ë°ì´í„° ì—°ë™

## ğŸ“‹ ì‘ì—… ê°œìš”
**ëª©í‘œ**: Riverpodì„ í™œìš©í•œ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶• ë° UI-ë°ì´í„° ì—°ë™
**ì˜ˆìƒ ê¸°ê°„**: 2ì¼
**ìš°ì„ ìˆœìœ„**: P0 (í•„ìˆ˜)

## ğŸ¯ ì‘ì—… ëª©í‘œ
1. Riverpod Provider ì•„í‚¤í…ì²˜ êµ¬ì¶•
2. ìƒíƒœ ê´€ë¦¬ ë¡œì§ êµ¬í˜„
3. UIì™€ Repository ì—°ê²°
4. ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”
5. ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œë”© ìƒíƒœ ê´€ë¦¬

## ğŸ“‚ ìƒì„±í•  íŒŒì¼ êµ¬ì¡°
```
lib/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ database_provider.dart
â”‚       â””â”€â”€ shared_preferences_provider.dart
â””â”€â”€ features/
    â””â”€â”€ routine/
        â””â”€â”€ presentation/
            â”œâ”€â”€ providers/
            â”‚   â”œâ”€â”€ routine_list_provider.dart
            â”‚   â”œâ”€â”€ routine_form_provider.dart
            â”‚   â”œâ”€â”€ filter_provider.dart
            â”‚   â”œâ”€â”€ sort_provider.dart
            â”‚   â”œâ”€â”€ completion_stats_provider.dart
            â”‚   â””â”€â”€ selected_routine_provider.dart
            â”œâ”€â”€ notifiers/
            â”‚   â”œâ”€â”€ routine_list_notifier.dart
            â”‚   â”œâ”€â”€ routine_form_notifier.dart
            â”‚   â””â”€â”€ completion_notifier.dart
            â””â”€â”€ states/
                â”œâ”€â”€ routine_list_state.dart
                â”œâ”€â”€ routine_form_state.dart
                â””â”€â”€ filter_state.dart
```

## ğŸ”§ ìƒì„¸ êµ¬í˜„ ê³„íš

### 1. Provider êµ¬ì¡°
```dart
// database_provider.dart
final databaseProvider = Provider<DatabaseHelper>((ref) {
  return DatabaseHelper();
});

// routine_repository_provider.dart
final routineRepositoryProvider = Provider<RoutineRepository>((ref) {
  final database = ref.watch(databaseProvider);
  return RoutineRepositoryImpl(database);
});
```

### 2. ë£¨í‹´ ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ê´€ë¦¬
```dart
// routine_list_state.dart
@freezed
class RoutineListState with _$RoutineListState {
  const factory RoutineListState({
    @Default([]) List<Routine> routines,
    @Default(false) bool isLoading,
    @Default(null) String? errorMessage,
    @Default(FilterType.all) FilterType filter,
    @Default(SortType.created) SortType sort,
  }) = _RoutineListState;
}

// routine_list_notifier.dart
class RoutineListNotifier extends StateNotifier<AsyncValue<List<Routine>>> {
  final RoutineRepository _repository;

  Future<void> loadRoutines() async {...}
  Future<void> addRoutine(Routine routine) async {...}
  Future<void> updateRoutine(Routine routine) async {...}
  Future<void> deleteRoutine(String id) async {...}
  Future<void> toggleCompletion(String id) async {...}
}

// routine_list_provider.dart
final routineListProvider = StateNotifierProvider<
  RoutineListNotifier,
  AsyncValue<List<Routine>>
>((ref) {
  final repository = ref.watch(routineRepositoryProvider);
  return RoutineListNotifier(repository);
});
```

### 3. í•„í„°/ì •ë ¬ Provider
```dart
// filter_provider.dart
enum FilterType { all, today, completed, incomplete }

final filterProvider = StateProvider<FilterType>((ref) => FilterType.all);

// sort_provider.dart
enum SortType { created, name, color, completion, custom }

final sortProvider = StateProvider<SortType>((ref) => SortType.created);

// filtered_routines_provider.dart
final filteredRoutinesProvider = Provider<AsyncValue<List<Routine>>>((ref) {
  final routines = ref.watch(routineListProvider);
  final filter = ref.watch(filterProvider);
  final sort = ref.watch(sortProvider);

  return routines.whenData((list) {
    var filtered = _applyFilter(list, filter);
    var sorted = _applySort(filtered, sort);
    return sorted;
  });
});
```

### 4. ì™„ë£Œ í†µê³„ Provider
```dart
// completion_stats_provider.dart
@freezed
class CompletionStats with _$CompletionStats {
  const factory CompletionStats({
    required int total,
    required int completed,
    required double percentage,
    required Map<String, int> streaks,
  }) = _CompletionStats;
}

final todayCompletionProvider = Provider<AsyncValue<CompletionStats>>((ref) {
  final routines = ref.watch(filteredRoutinesProvider);

  return routines.whenData((list) {
    final today = list.where((r) => r.isScheduledToday);
    final completed = today.where((r) => r.isCompletedToday);

    return CompletionStats(
      total: today.length,
      completed: completed.length,
      percentage: today.isEmpty ? 0 : (completed.length / today.length * 100),
      streaks: _calculateStreaks(list),
    );
  });
});
```

### 5. í¼ ìƒíƒœ ê´€ë¦¬
```dart
// routine_form_state.dart
@freezed
class RoutineFormState with _$RoutineFormState {
  const factory RoutineFormState({
    @Default('') String name,
    @Default(0) int iconIndex,
    @Default(0) int colorIndex,
    @Default(ScheduleType.daily) ScheduleType scheduleType,
    @Default([]) List<int> customDays,
    @Default(false) bool isValid,
    @Default(null) String? errorMessage,
  }) = _RoutineFormState;
}

// routine_form_notifier.dart
class RoutineFormNotifier extends StateNotifier<RoutineFormState> {
  void updateName(String name) {...}
  void updateIcon(int index) {...}
  void updateColor(int index) {...}
  void updateSchedule(ScheduleType type) {...}
  void updateCustomDays(List<int> days) {...}
  bool validate() {...}
  Future<void> submit() async {...}
}
```

### 6. Optimistic Update êµ¬í˜„
```dart
// toggleCompletion with optimistic update
Future<void> toggleCompletion(String routineId) async {
  // 1. ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (Optimistic)
  state.whenData((routines) {
    final index = routines.indexWhere((r) => r.id == routineId);
    if (index != -1) {
      final updated = [...routines];
      updated[index] = routines[index].copyWith(
        isCompletedToday: !routines[index].isCompletedToday,
      );
      state = AsyncValue.data(updated);
    }
  });

  // 2. ì‹¤ì œ DB ì—…ë°ì´íŠ¸
  try {
    await _repository.toggleCompletion(routineId, DateTime.now());
  } catch (e) {
    // 3. ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
    await loadRoutines();
    throw e;
  }
}
```

### 7. Stream ì—°ë™
```dart
// ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”
final routineStreamProvider = StreamProvider<List<Routine>>((ref) {
  final repository = ref.watch(routineRepositoryProvider);
  return repository.watchRoutines();
});

// Auto-dispose provider
final selectedRoutineProvider = StateProvider.autoDispose<Routine?>((ref) => null);
```

## ğŸ”„ ë°ì´í„° í”Œë¡œìš°

```
UI (Widget)
    â†“ User Action
Provider (State)
    â†“ Business Logic
Repository
    â†“ Data Operation
Database (SQLite)
    â†“ Result
Repository
    â†“ Data Model
Provider (State Update)
    â†“ Rebuild
UI (Widget)
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê³„íš
1. **Provider í…ŒìŠ¤íŠ¸**
   - ìƒíƒœ ë³€ê²½ í…ŒìŠ¤íŠ¸
   - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸
   - ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸

2. **Notifier í…ŒìŠ¤íŠ¸**
   - ë©”ì„œë“œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
   - ìƒíƒœ ì „í™˜ í…ŒìŠ¤íŠ¸

3. **í†µí•© í…ŒìŠ¤íŠ¸**
   - UI-Provider-Repository ì „ì²´ í”Œë¡œìš°
   - Optimistic update ë™ì‘
   - Stream ë™ê¸°í™”

## âš ï¸ ì£¼ì˜ì‚¬í•­
1. **Memory Leak ë°©ì§€**
   - autoDispose í™œìš©
   - Stream êµ¬ë… ê´€ë¦¬
   - Provider ìƒëª…ì£¼ê¸° ê´€ë¦¬

2. **ì„±ëŠ¥ ìµœì í™”**
   - ë¶ˆí•„ìš”í•œ rebuild ë°©ì§€
   - select í™œìš©
   - family modifier ì ì ˆíˆ ì‚¬ìš©

3. **ì—ëŸ¬ ì²˜ë¦¬**
   - AsyncValue ì—ëŸ¬ ìƒíƒœ ì²˜ë¦¬
   - ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€
   - ë¡¤ë°± ë©”ì»¤ë‹ˆì¦˜

## ğŸ¯ ì™„ë£Œ ê¸°ì¤€
- [ ] ëª¨ë“  Provider êµ¬í˜„ ì™„ë£Œ
- [ ] UI-ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™”
- [ ] Optimistic update ì •ìƒ ë™ì‘
- [ ] í•„í„°/ì •ë ¬ ê¸°ëŠ¥ êµ¬í˜„
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œë”© ìƒíƒœ ê´€ë¦¬

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„
Phase 4: í…ŒìŠ¤íŠ¸ ë° ì„±ëŠ¥ ìµœì í™”ë¡œ ì§„í–‰