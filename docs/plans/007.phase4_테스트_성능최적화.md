# 007. Phase 4: 테스트 및 성능 최적화

## 📋 작업 개요
**목표**: 앱 안정성 확보 및 성능 최적화
**예상 기간**: 2일
**우선순위**: P0 (필수)

## 🎯 작업 목표
1. 포괄적인 테스트 커버리지 구축
2. 성능 병목 지점 파악 및 개선
3. 메모리 누수 방지
4. 애니메이션 최적화 (60fps)
5. 배터리 사용량 최소화

## 📂 생성할 테스트 파일 구조
```
test/
├── unit/
│   ├── core/
│   │   └── database/
│   │       └── database_helper_test.dart
│   └── features/
│       └── routine/
│           ├── data/
│           │   ├── models/
│           │   │   ├── routine_model_test.dart
│           │   │   └── completion_record_model_test.dart
│           │   └── repositories/
│           │       └── routine_repository_test.dart
│           └── domain/
│               └── entities/
│                   └── routine_test.dart
├── widget/
│   └── features/
│       └── routine/
│           └── presentation/
│               ├── screens/
│               │   └── home_screen_test.dart
│               └── widgets/
│                   ├── routine_card_test.dart
│                   └── routine_form_test.dart
├── integration/
│   ├── routine_crud_test.dart
│   ├── completion_flow_test.dart
│   └── filter_sort_test.dart
└── golden/
    ├── routine_card_golden_test.dart
    └── home_screen_golden_test.dart
```

## 🔧 상세 구현 계획

### 1. Unit 테스트

#### 1.1 모델 테스트
```dart
// routine_model_test.dart
group('RoutineModel', () {
  test('should create routine with valid data', () {});
  test('should validate name length', () {});
  test('should serialize to JSON correctly', () {});
  test('should deserialize from JSON correctly', () {});
  test('should calculate isCompletedToday correctly', () {});
  test('should calculate currentStreak correctly', () {});
  test('should calculate completionRate correctly', () {});
});
```

#### 1.2 Repository 테스트
```dart
// routine_repository_test.dart
group('RoutineRepository', () {
  late MockDatabaseHelper mockDatabase;
  late RoutineRepositoryImpl repository;

  setUp(() {
    mockDatabase = MockDatabaseHelper();
    repository = RoutineRepositoryImpl(mockDatabase);
  });

  test('getAllRoutines returns sorted list', () async {});
  test('createRoutine generates UUID and saves', () async {});
  test('toggleCompletion updates completion history', () async {});
  test('deleteRoutine performs soft delete', () async {});
  test('handles database errors gracefully', () async {});
});
```

#### 1.3 Provider 테스트
```dart
// routine_list_provider_test.dart
group('RoutineListProvider', () {
  test('initial state is loading', () {});
  test('loads routines on initialization', () {});
  test('optimistic update works correctly', () {});
  test('rollback on error', () {});
  test('filter and sort work together', () {});
});
```

### 2. Widget 테스트

#### 2.1 루틴 카드 테스트
```dart
// routine_card_test.dart
testWidgets('RoutineCard shows correct UI for unchecked state', (tester) async {});
testWidgets('RoutineCard shows check icon when completed', (tester) async {});
testWidgets('Tapping routine card triggers callback', (tester) async {});
testWidgets('Long press shows context menu', (tester) async {});
testWidgets('Swipe gesture triggers delete', (tester) async {});
```

#### 2.2 홈 화면 테스트
```dart
// home_screen_test.dart
testWidgets('HomeScreen shows empty state when no routines', (tester) async {});
testWidgets('HomeScreen displays routine list', (tester) async {});
testWidgets('FAB opens bottom sheet', (tester) async {});
testWidgets('Pull to refresh works', (tester) async {});
```

### 3. Integration 테스트

```dart
// routine_crud_test.dart
testWidgets('User can create and check routine', (tester) async {
  app.main();
  await tester.pumpAndSettle();

  // 1. FAB 탭하여 바텀시트 열기
  // 2. 루틴 정보 입력
  // 3. 저장 버튼 탭
  // 4. 루틴 리스트에 표시 확인
  // 5. 루틴 체크하기
  // 6. 체크 상태 확인
  // 7. 앱 재시작 후 상태 유지 확인
});
```

### 4. Golden 테스트

```dart
// routine_card_golden_test.dart
testWidgets('RoutineCard golden test - all states', (tester) async {
  final routine = Routine(/*...*/);

  // Unchecked state
  await tester.pumpWidget(/*...*/);
  await expectLater(find.byType(RoutineCard),
    matchesGoldenFile('goldens/routine_card_unchecked.png'));

  // Checked state
  routine.isCompletedToday = true;
  await tester.pumpWidget(/*...*/);
  await expectLater(find.byType(RoutineCard),
    matchesGoldenFile('goldens/routine_card_checked.png'));
});
```

### 5. 성능 테스트

#### 5.1 렌더링 성능
```dart
test('List renders 100 items in <16ms', () async {
  final stopwatch = Stopwatch()..start();

  // 100개 루틴 렌더링
  await tester.pumpWidget(/*...*/);

  stopwatch.stop();
  expect(stopwatch.elapsedMilliseconds, lessThan(16)); // 60fps
});
```

#### 5.2 데이터베이스 성능
```dart
test('Database operations complete in acceptable time', () async {
  // Insert: < 50ms
  // Query: < 30ms
  // Update: < 40ms
  // Delete: < 30ms
});
```

#### 5.3 메모리 프로파일링
```dart
test('No memory leaks in provider lifecycle', () async {
  // Provider 생성/삭제 반복
  // 메모리 사용량 모니터링
  // Leak 감지
});
```

### 6. 성능 최적화 작업

#### 6.1 위젯 최적화
```dart
// const 생성자 활용
const RoutineCard({required this.routine});

// RepaintBoundary 적용
RepaintBoundary(
  child: AnimatedContainer(/*...*/)
);

// ListView.builder itemExtent 설정
ListView.builder(
  itemExtent: 80.0, // 고정 높이로 성능 향상
);
```

#### 6.2 상태 관리 최적화
```dart
// select를 통한 불필요한 rebuild 방지
final routineName = ref.watch(
  routineProvider.select((routine) => routine.name)
);

// family modifier로 개별 관리
final routineProvider = StateNotifierProvider.family<
  RoutineNotifier, Routine, String
>((ref, id) => RoutineNotifier(id));
```

#### 6.3 애니메이션 최적화
```dart
// AnimationController 재사용
class _RoutineCardState extends State<RoutineCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: Duration(milliseconds: 250),
      vsync: this,
    );
  }
}
```

## 🎯 성능 목표

### 앱 시작 시간
- Cold start: < 2초
- Warm start: < 0.5초

### 메모리 사용량
- 초기 실행: < 50MB
- 일반 사용: < 100MB
- 피크 사용: < 150MB

### 프레임 레이트
- 스크롤: 60fps 유지
- 애니메이션: 60fps 유지
- 체크 토글: < 200ms 응답

### 배터리 사용량
- 일일 사용: < 1%
- 백그라운드: 최소화

## 🧪 테스트 커버리지 목표
- Unit 테스트: 90% 이상
- Widget 테스트: 80% 이상
- Integration 테스트: 주요 플로우 100%

## ⚠️ 주의사항
1. **테스트 격리**
   - 각 테스트는 독립적으로 실행
   - setUp/tearDown 활용
   - Mock 데이터 사용

2. **CI/CD 통합**
   - GitHub Actions 설정
   - 자동 테스트 실행
   - 커버리지 리포트

3. **성능 모니터링**
   - Flutter DevTools 활용
   - Performance Overlay
   - Memory Profiler

## 🎯 완료 기준
- [ ] 테스트 커버리지 목표 달성
- [ ] 모든 성능 목표 충족
- [ ] 메모리 누수 없음
- [ ] 60fps 유지
- [ ] CI/CD 파이프라인 구축

## 📝 다음 단계
Phase 5: 홈 위젯 구현으로 진행 (Post-MVP)