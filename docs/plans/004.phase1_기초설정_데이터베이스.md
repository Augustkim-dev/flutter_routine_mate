# 004. Phase 1: 기초 설정 및 데이터베이스 구축

## 📋 작업 개요
**목표**: SQLite 데이터베이스 설정 및 기본 데이터 모델 구현
**예상 기간**: 2일
**우선순위**: P0 (필수)

## 🎯 작업 목표
1. SQLite 데이터베이스 초기화 및 테이블 생성
2. 데이터 모델 클래스 구현
3. Repository 패턴 구현
4. DAO 클래스 작성
5. 기본 CRUD 작업 테스트

## 📂 생성할 파일 구조
```
lib/
├── core/
│   ├── database/
│   │   ├── database_helper.dart
│   │   └── app_database.dart
│   └── utils/
│       ├── constants.dart
│       └── uuid_generator.dart
└── features/
    └── routine/
        ├── data/
        │   ├── models/
        │   │   ├── routine_model.dart
        │   │   ├── completion_record_model.dart
        │   │   └── app_settings_model.dart
        │   ├── datasources/
        │   │   └── routine_local_datasource.dart
        │   └── repositories/
        │       └── routine_repository_impl.dart
        └── domain/
            ├── entities/
            │   ├── routine.dart
            │   ├── completion_record.dart
            │   └── schedule_type.dart
            └── repositories/
                └── routine_repository.dart
```

## 🔧 상세 구현 계획

### 1. 데이터베이스 설정 (database_helper.dart)
```dart
// 주요 기능:
- SQLite 데이터베이스 초기화
- 테이블 생성 (routines, completion_records, app_settings, analytics_data)
- 인덱스 생성
- 마이그레이션 로직
- 데이터베이스 버전 관리
```

### 2. 모델 클래스
```dart
// routine_model.dart
- id: String (UUID)
- name: String (1-20자)
- iconIndex: int (0-29)
- colorIndex: int (0-7)
- scheduleType: ScheduleType enum
- customDays: List<int>?
- sortOrder: int
- reminderTime: String?
- isReminderEnabled: bool
- createdAt: DateTime
- updatedAt: DateTime
- deletedAt: DateTime? (soft delete)

// completion_record_model.dart
- id: int (auto-increment)
- routineId: String
- date: String (YYYY-MM-DD)
- isCompleted: bool
- completedAt: DateTime?
- note: String?
- createdAt: DateTime
```

### 3. Repository 구현
```dart
// routine_repository.dart (abstract)
abstract class RoutineRepository {
  Future<List<Routine>> getAllRoutines();
  Future<Routine?> getRoutineById(String id);
  Future<String> createRoutine(Routine routine);
  Future<void> updateRoutine(Routine routine);
  Future<void> deleteRoutine(String id);
  Future<void> toggleCompletion(String routineId, DateTime date);
  Future<Map<String, bool>> getCompletionHistory(String routineId);
  Stream<List<Routine>> watchRoutines();
}

// routine_repository_impl.dart
- SQLite 트랜잭션 처리
- 에러 핸들링
- 데이터 변환 (Entity ↔ Model)
```

### 4. DAO (Data Access Object)
```dart
// routine_dao.dart
- insert, update, delete, select 쿼리
- 복잡한 쿼리 (통계, 필터링)
- 배치 작업
- 트랜잭션 관리
```

## 🧪 테스트 계획
1. **데이터베이스 테스트**
   - 테이블 생성 확인
   - CRUD 작업 테스트
   - 트랜잭션 롤백 테스트

2. **모델 테스트**
   - JSON 직렬화/역직렬화
   - 유효성 검증
   - 기본값 테스트

3. **Repository 테스트**
   - 모든 메서드 단위 테스트
   - 에러 케이스 처리
   - Stream 테스트

## 📦 필요한 패키지
```yaml
dependencies:
  sqflite: ^2.3.0
  path: ^1.8.3
  uuid: ^4.2.1

dev_dependencies:
  sqflite_common_ffi: ^2.3.0  # 데스크톱 테스트용
  mockito: ^5.4.3
  build_runner: ^2.4.7
```

## ⚠️ 주의사항
1. **데이터베이스 버전 관리**
   - 초기 버전은 1로 설정
   - 향후 스키마 변경 시 마이그레이션 코드 필수

2. **Soft Delete 구현**
   - deleted_at 필드 활용
   - 실제 삭제 대신 플래그 처리
   - 30일 후 자동 삭제 배치 작업 고려

3. **인덱스 최적화**
   - routine_id + date 복합 인덱스
   - deleted_at 단일 인덱스
   - 쿼리 성능 모니터링

4. **트랜잭션 처리**
   - 루틴 삭제 시 completion_records도 함께 삭제
   - 완료 기록 저장 실패 시 롤백

## 🎯 완료 기준
- [ ] 데이터베이스 초기화 성공
- [ ] 모든 테이블 생성 확인
- [ ] 기본 CRUD 작업 정상 동작
- [ ] 단위 테스트 통과율 90% 이상
- [ ] 에러 핸들링 구현 완료

## 📝 다음 단계
Phase 2: 핵심 UI 및 루틴 관리 기능 구현으로 진행