# 008. Phase 5: í™ˆ ìœ„ì ¯ êµ¬í˜„ (Post-MVP)

## ğŸ“‹ ì‘ì—… ê°œìš”
**ëª©í‘œ**: iOS/Android ë„¤ì´í‹°ë¸Œ í™ˆ ìœ„ì ¯ êµ¬í˜„ ë° ì•±ê³¼ì˜ ë™ê¸°í™”
**ì˜ˆìƒ ê¸°ê°„**: 3ì¼
**ìš°ì„ ìˆœìœ„**: P1 (Post-MVP)

## ğŸ¯ ì‘ì—… ëª©í‘œ
1. iOS ìœ„ì ¯ êµ¬í˜„ (WidgetKit)
2. Android ìœ„ì ¯ êµ¬í˜„ (AppWidget)
3. Flutter MethodChannel ì„¤ì •
4. ìœ„ì ¯-ì•± ê°„ ë°ì´í„° ë™ê¸°í™”
5. ìœ„ì ¯ ì„¤ì • í™”ë©´ êµ¬í˜„

## ğŸ“‚ ìƒì„±í•  íŒŒì¼ êµ¬ì¡°
```
# Flutter ì¸¡
lib/
â””â”€â”€ features/
    â””â”€â”€ widget/
        â”œâ”€â”€ data/
        â”‚   â”œâ”€â”€ services/
        â”‚   â”‚   â””â”€â”€ widget_service.dart
        â”‚   â””â”€â”€ models/
        â”‚       â””â”€â”€ widget_data_model.dart
        â”œâ”€â”€ domain/
        â”‚   â””â”€â”€ usecases/
        â”‚       â”œâ”€â”€ update_widget_usecase.dart
        â”‚       â””â”€â”€ sync_widget_data_usecase.dart
        â””â”€â”€ presentation/
            â”œâ”€â”€ screens/
            â”‚   â””â”€â”€ widget_settings_screen.dart
            â””â”€â”€ widgets/
                â””â”€â”€ widget_routine_selector.dart

# iOS ì¸¡
ios/
â””â”€â”€ RoutineWidget/
    â”œâ”€â”€ RoutineWidget.swift
    â”œâ”€â”€ RoutineWidgetBundle.swift
    â”œâ”€â”€ Provider/
    â”‚   â””â”€â”€ RoutineProvider.swift
    â”œâ”€â”€ Views/
    â”‚   â”œâ”€â”€ SmallWidgetView.swift
    â”‚   â”œâ”€â”€ MediumWidgetView.swift
    â”‚   â””â”€â”€ LargeWidgetView.swift
    â”œâ”€â”€ Models/
    â”‚   â””â”€â”€ RoutineEntry.swift
    â””â”€â”€ Intents/
        â””â”€â”€ ConfigurationIntent.swift

# Android ì¸¡
android/app/src/main/
â”œâ”€â”€ java/com/routinemate/app/
â”‚   â””â”€â”€ widget/
â”‚       â”œâ”€â”€ RoutineWidgetProvider.kt
â”‚       â”œâ”€â”€ RoutineWidgetService.kt
â”‚       â””â”€â”€ RoutineWidgetConfigActivity.kt
â””â”€â”€ res/
    â”œâ”€â”€ layout/
    â”‚   â”œâ”€â”€ widget_routine_small.xml
    â”‚   â”œâ”€â”€ widget_routine_medium.xml
    â”‚   â””â”€â”€ widget_routine_large.xml
    â””â”€â”€ xml/
        â””â”€â”€ routine_widget_info.xml
```

## ğŸ”§ ìƒì„¸ êµ¬í˜„ ê³„íš

### 1. Flutter MethodChannel ì„¤ì •
```dart
// widget_service.dart
class WidgetService {
  static const platform = MethodChannel('com.routinemate.app/widget');

  // ìœ„ì ¯ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
  static Future<void> updateWidget(String routineId) async {
    try {
      final routine = await _getRoutine(routineId);
      await platform.invokeMethod('updateWidget', {
        'routineId': routine.id,
        'name': routine.name,
        'iconIndex': routine.iconIndex,
        'colorIndex': routine.colorIndex,
        'isCompleted': routine.isCompletedToday,
        'streak': routine.currentStreak,
      });
    } on PlatformException catch (e) {
      debugPrint("Failed to update widget: ${e.message}");
    }
  }

  // ìœ„ì ¯ì—ì„œ ì•¡ì…˜ ìˆ˜ì‹ 
  static void setupMethodCallHandler() {
    platform.setMethodCallHandler((call) async {
      switch (call.method) {
        case 'toggleFromWidget':
          final routineId = call.arguments['routineId'] as String;
          await _toggleRoutineFromWidget(routineId);
          break;
        case 'openRoutine':
          final routineId = call.arguments['routineId'] as String;
          _navigateToRoutine(routineId);
          break;
      }
    });
  }

  // ëª¨ë“  ìœ„ì ¯ ì—…ë°ì´íŠ¸
  static Future<void> updateAllWidgets() async {
    final settings = await _getWidgetSettings();
    final routines = await _getRoutines(settings.selectedRoutineIds);

    await platform.invokeMethod('updateAllWidgets', {
      'routines': routines.map((r) => r.toWidgetData()).toList(),
    });
  }
}
```

### 2. iOS ìœ„ì ¯ êµ¬í˜„ (SwiftUI + WidgetKit)

#### 2.1 Widget Entry
```swift
// RoutineEntry.swift
struct RoutineEntry: TimelineEntry {
    let date: Date
    let routines: [RoutineData]
    let configuration: ConfigurationIntent
}

struct RoutineData: Codable {
    let id: String
    let name: String
    let iconIndex: Int
    let colorIndex: Int
    let isCompleted: Bool
    let streak: Int
}
```

#### 2.2 Widget Views
```swift
// SmallWidgetView.swift (1x1)
struct SmallWidgetView: View {
    let routine: RoutineData

    var body: some View {
        Link(destination: URL(string: "routinemate://toggle/\(routine.id)")!) {
            VStack(spacing: 8) {
                Image(systemName: getIcon(routine.iconIndex))
                    .font(.system(size: 24))
                    .foregroundColor(getColor(routine.colorIndex))

                Text(routine.name)
                    .font(.caption)
                    .lineLimit(2)

                Image(systemName: routine.isCompleted ? "checkmark.circle.fill" : "circle")
                    .font(.system(size: 20))
                    .foregroundColor(routine.isCompleted ? .green : .gray)
            }
            .padding()
            .background(ContainerRelativeShape().fill(Color(.systemBackground)))
        }
    }
}

// MediumWidgetView.swift (2x2)
struct MediumWidgetView: View {
    let routines: [RoutineData]

    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("ì˜¤ëŠ˜ì˜ ë£¨í‹´")
                .font(.headline)

            ForEach(routines.prefix(3)) { routine in
                Link(destination: URL(string: "routinemate://toggle/\(routine.id)")!) {
                    HStack {
                        Image(systemName: getIcon(routine.iconIndex))
                        Text(routine.name)
                        Spacer()
                        Image(systemName: routine.isCompleted ? "checkmark.circle.fill" : "circle")
                    }
                }
            }

            Text("\(completedCount)/\(totalCount) ì™„ë£Œ")
                .font(.caption)
                .foregroundColor(.secondary)
        }
        .padding()
    }
}
```

#### 2.3 Timeline Provider
```swift
// RoutineProvider.swift
struct RoutineProvider: IntentTimelineProvider {
    func getTimeline(for configuration: ConfigurationIntent,
                    in context: Context,
                    completion: @escaping (Timeline<RoutineEntry>) -> ()) {

        let routines = loadRoutinesFromSharedContainer()
        let entry = RoutineEntry(date: Date(), routines: routines, configuration: configuration)

        // ìì •ì— ë¦¬í”„ë ˆì‹œ
        let midnight = Calendar.current.startOfDay(for: Date()).addingTimeInterval(86400)
        let timeline = Timeline(entries: [entry], policy: .after(midnight))

        completion(timeline)
    }
}
```

### 3. Android ìœ„ì ¯ êµ¬í˜„

#### 3.1 Widget Provider
```kotlin
// RoutineWidgetProvider.kt
class RoutineWidgetProvider : AppWidgetProvider() {

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        for (appWidgetId in appWidgetIds) {
            updateAppWidget(context, appWidgetManager, appWidgetId)
        }
    }

    private fun updateAppWidget(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetId: Int
    ) {
        val routines = loadRoutinesFromSharedPrefs(context)
        val views = getRemoteViews(context, routines)

        // í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
        routines.forEachIndexed { index, routine ->
            val intent = Intent(context, RoutineWidgetProvider::class.java).apply {
                action = ACTION_TOGGLE_ROUTINE
                putExtra(EXTRA_ROUTINE_ID, routine.id)
            }
            val pendingIntent = PendingIntent.getBroadcast(
                context,
                routine.id.hashCode(),
                intent,
                PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
            )
            views.setOnClickPendingIntent(getViewId(index), pendingIntent)
        }

        appWidgetManager.updateAppWidget(appWidgetId, views)
    }

    override fun onReceive(context: Context, intent: Intent) {
        super.onReceive(context, intent)

        if (intent.action == ACTION_TOGGLE_ROUTINE) {
            val routineId = intent.getStringExtra(EXTRA_ROUTINE_ID)
            // Flutterë¡œ ì „ë‹¬
            MainActivity.methodChannel?.invokeMethod(
                "toggleFromWidget",
                mapOf("routineId" to routineId)
            )
            // ìœ„ì ¯ ì—…ë°ì´íŠ¸
            updateAllWidgets(context)
        }
    }
}
```

#### 3.2 Widget Layout
```xml
<!-- widget_routine_medium.xml -->
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp"
    android:background="@drawable/widget_background">

    <TextView
        android:id="@+id/widget_title"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ì˜¤ëŠ˜ì˜ ë£¨í‹´"
        android:textSize="16sp"
        android:textStyle="bold"/>

    <LinearLayout
        android:id="@+id/routines_container"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:layout_marginTop="8dp">

        <!-- ë™ì ìœ¼ë¡œ ë£¨í‹´ í•­ëª© ì¶”ê°€ -->

    </LinearLayout>

    <TextView
        android:id="@+id/completion_text"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="0/0 ì™„ë£Œ"
        android:textSize="12sp"
        android:layout_marginTop="8dp"/>

</LinearLayout>
```

### 4. ìœ„ì ¯ ì„¤ì • í™”ë©´
```dart
// widget_settings_screen.dart
class WidgetSettingsScreen extends ConsumerStatefulWidget {
  @override
  _WidgetSettingsScreenState createState() => _WidgetSettingsScreenState();
}

class _WidgetSettingsScreenState extends ConsumerState<WidgetSettingsScreen> {
  List<String> selectedRoutineIds = [];

  @override
  Widget build(BuildContext context) {
    final routines = ref.watch(routineListProvider);

    return Scaffold(
      appBar: AppBar(
        title: Text('ìœ„ì ¯ ì„¤ì •'),
        actions: [
          TextButton(
            onPressed: _saveSettings,
            child: Text('ì €ì¥'),
          ),
        ],
      ),
      body: Column(
        children: [
          Padding(
            padding: EdgeInsets.all(16),
            child: Text(
              'í™ˆ í™”ë©´ ìœ„ì ¯ì— í‘œì‹œí•  ë£¨í‹´ì„ ì„ íƒí•˜ì„¸ìš” (ìµœëŒ€ 6ê°œ)',
              style: Theme.of(context).textTheme.bodyMedium,
            ),
          ),
          Expanded(
            child: routines.when(
              data: (list) => ListView.builder(
                itemCount: list.length,
                itemBuilder: (context, index) {
                  final routine = list[index];
                  final isSelected = selectedRoutineIds.contains(routine.id);

                  return CheckboxListTile(
                    title: Text(routine.name),
                    value: isSelected,
                    onChanged: selectedRoutineIds.length < 6 || isSelected
                        ? (value) => _toggleSelection(routine.id)
                        : null,
                    secondary: Icon(
                      getIconData(routine.iconIndex),
                      color: getColor(routine.colorIndex),
                    ),
                  );
                },
              ),
              loading: () => CircularProgressIndicator(),
              error: (error, stack) => Text('ì˜¤ë¥˜ ë°œìƒ'),
            ),
          ),
        ],
      ),
    );
  }

  void _toggleSelection(String routineId) {
    setState(() {
      if (selectedRoutineIds.contains(routineId)) {
        selectedRoutineIds.remove(routineId);
      } else {
        selectedRoutineIds.add(routineId);
      }
    });
  }

  Future<void> _saveSettings() async {
    await WidgetService.saveWidgetSettings(selectedRoutineIds);
    await WidgetService.updateAllWidgets();
    Navigator.pop(context);
  }
}
```

### 5. ìë™ ì—…ë°ì´íŠ¸ ë¡œì§
```dart
// ì•±ì—ì„œ ë£¨í‹´ ì²´í¬ ì‹œ
Future<void> toggleRoutineCompletion(String routineId) async {
  // DB ì—…ë°ì´íŠ¸
  await repository.toggleCompletion(routineId);

  // ìœ„ì ¯ ì—…ë°ì´íŠ¸
  await WidgetService.updateWidget(routineId);
}

// ìì • ë¦¬ì…‹
void scheduleWidgetReset() {
  final now = DateTime.now();
  final midnight = DateTime(now.year, now.month, now.day + 1);
  final duration = midnight.difference(now);

  Timer(duration, () async {
    await WidgetService.resetAllWidgets();
    scheduleWidgetReset(); // ë‹¤ìŒ ìì • ì˜ˆì•½
  });
}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê³„íš
1. **ìœ„ì ¯ ë Œë”ë§ í…ŒìŠ¤íŠ¸**
   - ê° í¬ê¸°ë³„ ë ˆì´ì•„ì›ƒ í™•ì¸
   - ë‹¤í¬ëª¨ë“œ ì§€ì›
   - ë‹¤ì–‘í•œ í™”ë©´ ë°€ë„

2. **ë™ê¸°í™” í…ŒìŠ¤íŠ¸**
   - ì•± â†’ ìœ„ì ¯ ì—…ë°ì´íŠ¸
   - ìœ„ì ¯ â†’ ì•± ì•¡ì…˜
   - ì˜¤í”„ë¼ì¸ ìƒíƒœ ì²˜ë¦¬

3. **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**
   - ìœ„ì ¯ ì—…ë°ì´íŠ¸ ì†ë„
   - ë°°í„°ë¦¬ ì‚¬ìš©ëŸ‰
   - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

## âš ï¸ ì£¼ì˜ì‚¬í•­
1. **iOS ì œì•½ì‚¬í•­**
   - WidgetKitì€ iOS 14+ í•„ìš”
   - ìœ„ì ¯ ì—…ë°ì´íŠ¸ ì œí•œ (ì¼ì¼ ìµœëŒ€ íšŸìˆ˜)
   - ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ ì œí•œ

2. **Android ì œì•½ì‚¬í•­**
   - ë‹¤ì–‘í•œ ëŸ°ì²˜ í˜¸í™˜ì„±
   - ìœ„ì ¯ í¬ê¸° ìœ ì—°ì„±
   - ì—…ë°ì´íŠ¸ ë¹ˆë„ ì œí•œ

3. **ë°ì´í„° ë™ê¸°í™”**
   - App Group (iOS) / SharedPreferences (Android) ì‚¬ìš©
   - ë°ì´í„° í¬ê¸° ì œí•œ
   - ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

## ğŸ¯ ì™„ë£Œ ê¸°ì¤€
- [ ] iOS ìœ„ì ¯ 3ê°€ì§€ í¬ê¸° êµ¬í˜„
- [ ] Android ìœ„ì ¯ 3ê°€ì§€ í¬ê¸° êµ¬í˜„
- [ ] ìœ„ì ¯-ì•± ì–‘ë°©í–¥ í†µì‹ 
- [ ] ìœ„ì ¯ ì„¤ì • í™”ë©´ êµ¬í˜„
- [ ] ìë™ ì—…ë°ì´íŠ¸ ë° ìì • ë¦¬ì…‹

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„
Phase 6: ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬í˜„ìœ¼ë¡œ ì§„í–‰