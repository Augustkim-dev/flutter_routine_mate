# 010. Phase 7: 통계 및 분석 기능

## 📋 작업 개요
**목표**: 사용자 행동 분석 및 통계 대시보드 구현
**예상 기간**: 2일
**우선순위**: P2 (Future Enhancement)

## 🎯 작업 목표
1. Firebase Analytics 연동
2. 로컬 통계 데이터 수집
3. 통계 대시보드 UI 구현
4. AdMob 광고 연동
5. 데이터 시각화 컴포넌트

## 📂 생성할 파일 구조
```
lib/
├── core/
│   └── services/
│       ├── analytics_service.dart
│       └── ad_service.dart
└── features/
    └── statistics/
        ├── data/
        │   ├── models/
        │   │   ├── statistics_model.dart
        │   │   └── streak_model.dart
        │   └── repositories/
        │       └── statistics_repository_impl.dart
        ├── domain/
        │   ├── entities/
        │   │   ├── routine_statistics.dart
        │   │   └── completion_heatmap.dart
        │   └── usecases/
        │       ├── calculate_statistics_usecase.dart
        │       └── generate_heatmap_usecase.dart
        └── presentation/
            ├── screens/
            │   ├── statistics_screen.dart
            │   └── routine_detail_screen.dart
            ├── widgets/
            │   ├── statistics_card.dart
            │   ├── streak_indicator.dart
            │   ├── completion_chart.dart
            │   ├── weekly_heatmap.dart
            │   ├── monthly_calendar.dart
            │   └── progress_ring.dart
            └── providers/
                └── statistics_provider.dart
```

## 🔧 상세 구현 계획

### 1. Firebase Analytics 설정
```dart
// analytics_service.dart
import 'package:firebase_analytics/firebase_analytics.dart';
import 'package:firebase_analytics/observer.dart';

class AnalyticsService {
  static final FirebaseAnalytics _analytics = FirebaseAnalytics.instance;
  static final FirebaseAnalyticsObserver observer =
      FirebaseAnalyticsObserver(analytics: _analytics);

  // 이벤트 로깅 메서드
  static Future<void> logRoutineAdded({
    required String routineId,
    required String scheduleType,
    int? iconIndex,
    int? colorIndex,
  }) async {
    await _analytics.logEvent(
      name: 'routine_added',
      parameters: {
        'routine_id': routineId,
        'schedule_type': scheduleType,
        'icon_index': iconIndex,
        'color_index': colorIndex,
        'timestamp': DateTime.now().toIso8601String(),
      },
    );
  }

  static Future<void> logRoutineCompleted({
    required String routineId,
    required String source, // 'app', 'widget', 'notification'
    int? currentStreak,
  }) async {
    await _analytics.logEvent(
      name: 'routine_completed',
      parameters: {
        'routine_id': routineId,
        'source': source,
        'current_streak': currentStreak,
        'time_of_day': DateTime.now().hour, // 완료 시간대 분석
        'day_of_week': DateTime.now().weekday,
      },
    );
  }

  static Future<void> logStreakAchieved({
    required String routineId,
    required int streakDays,
  }) async {
    await _analytics.logEvent(
      name: 'streak_achieved',
      parameters: {
        'routine_id': routineId,
        'streak_days': streakDays,
        'achievement_type': _getAchievementType(streakDays),
      },
    );
  }

  static Future<void> logScreenView(String screenName) async {
    await _analytics.logScreenView(
      screenName: screenName,
      screenClass: '${screenName}Screen',
    );
  }

  static Future<void> setUserProperties({
    required int totalRoutines,
    required double avgCompletionRate,
    required String primaryUsageTime,
  }) async {
    await _analytics.setUserProperty(
      name: 'total_routines',
      value: totalRoutines.toString(),
    );
    await _analytics.setUserProperty(
      name: 'avg_completion_rate',
      value: avgCompletionRate.toStringAsFixed(0),
    );
    await _analytics.setUserProperty(
      name: 'primary_usage_time',
      value: primaryUsageTime,
    );
  }

  static String _getAchievementType(int days) {
    if (days >= 365) return 'legendary';
    if (days >= 100) return 'expert';
    if (days >= 30) return 'advanced';
    if (days >= 7) return 'intermediate';
    return 'beginner';
  }
}
```

### 2. 통계 데이터 모델
```dart
// routine_statistics.dart
class RoutineStatistics {
  final String routineId;
  final String routineName;
  final int totalDays;
  final int completedDays;
  final double completionRate;
  final int currentStreak;
  final int bestStreak;
  final DateTime? lastCompletedAt;
  final Map<int, double> weeklyPattern; // 요일별 완료율
  final Map<int, double> hourlyPattern; // 시간대별 완료 분포
  final List<CompletionTrend> monthlyTrend;

  double get weeklyCompletionRate {
    final lastWeek = DateTime.now().subtract(Duration(days: 7));
    // 최근 7일 완료율 계산
  }

  String get mostProductiveDay {
    // 가장 완료율이 높은 요일
  }

  String get mostProductiveTime {
    // 가장 자주 완료하는 시간대
  }
}

// completion_heatmap.dart
class CompletionHeatmap {
  final DateTime startDate;
  final DateTime endDate;
  final Map<DateTime, double> data; // 날짜별 완료율 (0.0 ~ 1.0)

  List<List<HeatmapCell>> getWeeklyGrid() {
    // 주별 그리드 데이터 생성
  }

  Color getColorForValue(double value) {
    // 값에 따른 색상 반환 (그라데이션)
    if (value == 0) return Colors.grey[100]!;
    if (value < 0.25) return Colors.green[100]!;
    if (value < 0.5) return Colors.green[300]!;
    if (value < 0.75) return Colors.green[500]!;
    return Colors.green[700]!;
  }
}
```

### 3. 통계 대시보드 UI
```dart
// statistics_screen.dart
class StatisticsScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final statistics = ref.watch(statisticsProvider);

    return Scaffold(
      appBar: AppBar(
        title: Text('통계'),
        actions: [
          PopupMenuButton<DateRange>(
            onSelected: (range) {
              ref.read(dateRangeProvider.notifier).state = range;
            },
            itemBuilder: (context) => [
              PopupMenuItem(value: DateRange.week, child: Text('주간')),
              PopupMenuItem(value: DateRange.month, child: Text('월간')),
              PopupMenuItem(value: DateRange.year, child: Text('연간')),
              PopupMenuItem(value: DateRange.all, child: Text('전체')),
            ],
          ),
        ],
      ),
      body: statistics.when(
        data: (stats) => CustomScrollView(
          slivers: [
            // 전체 요약 카드
            SliverToBoxAdapter(
              child: _buildSummaryCard(stats),
            ),

            // 주간 히트맵
            SliverToBoxAdapter(
              child: _buildWeeklyHeatmap(stats),
            ),

            // 루틴별 통계
            SliverList(
              delegate: SliverChildBuilderDelegate(
                (context, index) => _buildRoutineStatCard(stats.routines[index]),
                childCount: stats.routines.length,
              ),
            ),

            // AdMob 배너
            SliverToBoxAdapter(
              child: _buildAdBanner(),
            ),
          ],
        ),
        loading: () => Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(child: Text('오류 발생')),
      ),
    );
  }

  Widget _buildSummaryCard(OverallStatistics stats) {
    return Card(
      margin: EdgeInsets.all(16),
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            Text('전체 완료율', style: TextStyle(fontSize: 14, color: Colors.grey)),
            SizedBox(height: 8),
            CircularProgressIndicator(
              value: stats.overallCompletionRate,
              strokeWidth: 8,
              backgroundColor: Colors.grey[200],
              valueColor: AlwaysStoppedAnimation(Colors.green),
            ),
            SizedBox(height: 8),
            Text(
              '${(stats.overallCompletionRate * 100).toStringAsFixed(0)}%',
              style: TextStyle(fontSize: 32, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 16),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              children: [
                _buildStatItem('활성 루틴', stats.activeRoutines.toString()),
                _buildStatItem('완료 횟수', stats.totalCompletions.toString()),
                _buildStatItem('최고 연속', '${stats.bestStreak}일'),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
```

### 4. 히트맵 위젯
```dart
// weekly_heatmap.dart
class WeeklyHeatmap extends StatelessWidget {
  final List<RoutineCompletion> completions;
  final int weeks;

  const WeeklyHeatmap({
    required this.completions,
    this.weeks = 12,
  });

  @override
  Widget build(BuildContext context) {
    final heatmapData = _generateHeatmapData();

    return Card(
      margin: EdgeInsets.all(16),
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '최근 ${weeks}주 활동',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            SizedBox(height: 16),
            SingleChildScrollView(
              scrollDirection: Axis.horizontal,
              reverse: true,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // 요일 라벨
                  Row(
                    children: [
                      SizedBox(width: 30),
                      ...List.generate(weeks, (index) => SizedBox(width: 20)),
                    ],
                  ),
                  // 히트맵 그리드
                  ...List.generate(7, (dayIndex) {
                    return Row(
                      children: [
                        // 요일 라벨
                        SizedBox(
                          width: 30,
                          child: Text(
                            _getDayLabel(dayIndex),
                            style: TextStyle(fontSize: 12),
                          ),
                        ),
                        // 히트맵 셀
                        ...List.generate(weeks, (weekIndex) {
                          final value = heatmapData[weekIndex][dayIndex];
                          return Container(
                            width: 18,
                            height: 18,
                            margin: EdgeInsets.all(1),
                            decoration: BoxDecoration(
                              color: _getColorForValue(value),
                              borderRadius: BorderRadius.circular(2),
                            ),
                          );
                        }),
                      ],
                    );
                  }),
                ],
              ),
            ),
            SizedBox(height: 16),
            // 범례
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text('적음', style: TextStyle(fontSize: 12)),
                SizedBox(width: 8),
                ...List.generate(5, (index) {
                  return Container(
                    width: 16,
                    height: 16,
                    margin: EdgeInsets.symmetric(horizontal: 2),
                    decoration: BoxDecoration(
                      color: _getColorForValue(index / 4),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  );
                }),
                SizedBox(width: 8),
                Text('많음', style: TextStyle(fontSize: 12)),
              ],
            ),
          ],
        ),
      ),
    );
  }

  String _getDayLabel(int index) {
    const days = ['월', '화', '수', '목', '금', '토', '일'];
    return days[index];
  }

  Color _getColorForValue(double value) {
    if (value == 0) return Colors.grey[100]!;
    if (value < 0.25) return Colors.green[200]!;
    if (value < 0.5) return Colors.green[400]!;
    if (value < 0.75) return Colors.green[600]!;
    return Colors.green[800]!;
  }
}
```

### 5. 완료율 차트
```dart
// completion_chart.dart
class CompletionChart extends StatelessWidget {
  final List<ChartData> data;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 200,
      padding: EdgeInsets.all(16),
      child: CustomPaint(
        painter: ChartPainter(data: data),
        child: Container(),
      ),
    );
  }
}

class ChartPainter extends CustomPainter {
  final List<ChartData> data;

  ChartPainter({required this.data});

  @override
  void paint(Canvas canvas, Size size) {
    // 축 그리기
    final axisPaint = Paint()
      ..color = Colors.grey
      ..strokeWidth = 1;

    // Y축
    canvas.drawLine(
      Offset(40, 0),
      Offset(40, size.height - 30),
      axisPaint,
    );

    // X축
    canvas.drawLine(
      Offset(40, size.height - 30),
      Offset(size.width, size.height - 30),
      axisPaint,
    );

    // 데이터 포인트 그리기
    final linePaint = Paint()
      ..color = Colors.blue
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    final path = Path();
    for (int i = 0; i < data.length; i++) {
      final x = 40 + (size.width - 40) * (i / (data.length - 1));
      final y = (size.height - 30) * (1 - data[i].value);

      if (i == 0) {
        path.moveTo(x, y);
      } else {
        path.lineTo(x, y);
      }

      // 데이터 포인트 원
      canvas.drawCircle(
        Offset(x, y),
        4,
        Paint()..color = Colors.blue,
      );
    }

    canvas.drawPath(path, linePaint);
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}
```

### 6. AdMob 광고 연동
```dart
// ad_service.dart
import 'package:google_mobile_ads/google_mobile_ads.dart';

class AdService {
  static final AdService _instance = AdService._internal();
  factory AdService() => _instance;
  AdService._internal();

  static const String _bannerAdUnitId = Platform.isIOS
      ? 'ca-app-pub-xxxxx/xxxxx' // iOS 광고 단위 ID
      : 'ca-app-pub-xxxxx/xxxxx'; // Android 광고 단위 ID

  BannerAd? _bannerAd;
  bool _isBannerAdReady = false;

  Future<void> initialize() async {
    await MobileAds.instance.initialize();
    _loadBannerAd();
  }

  void _loadBannerAd() {
    _bannerAd = BannerAd(
      adUnitId: _bannerAdUnitId,
      size: AdSize.banner,
      request: AdRequest(),
      listener: BannerAdListener(
        onAdLoaded: (_) {
          _isBannerAdReady = true;
          AnalyticsService.logAdImpression(_bannerAdUnitId);
        },
        onAdFailedToLoad: (ad, error) {
          print('Failed to load banner ad: ${error.message}');
          _isBannerAdReady = false;
          ad.dispose();
        },
      ),
    );

    _bannerAd!.load();
  }

  Widget getBannerAdWidget() {
    if (_isBannerAdReady && _bannerAd != null) {
      return Container(
        alignment: Alignment.center,
        width: _bannerAd!.size.width.toDouble(),
        height: _bannerAd!.size.height.toDouble(),
        child: AdWidget(ad: _bannerAd!),
      );
    } else {
      return SizedBox.shrink();
    }
  }

  void dispose() {
    _bannerAd?.dispose();
  }
}
```

## 🧪 테스트 계획
1. **통계 계산 테스트**
   - 완료율 정확성
   - 스트릭 계산
   - 시간대별 분석

2. **UI 테스트**
   - 차트 렌더링
   - 히트맵 표시
   - 반응형 레이아웃

3. **Analytics 테스트**
   - 이벤트 전송
   - 파라미터 검증
   - 디버그 뷰 확인

## ⚠️ 주의사항
1. **성능 고려**
   - 대량 데이터 처리 최적화
   - 차트 렌더링 성능
   - 메모리 사용량

2. **광고 정책**
   - AdMob 정책 준수
   - 광고 배치 가이드라인
   - 사용자 경험 고려

3. **개인정보**
   - Analytics 데이터 익명화
   - GDPR/CCPA 준수
   - 옵트아웃 옵션

## 🎯 완료 기준
- [ ] Firebase Analytics 연동
- [ ] 통계 대시보드 구현
- [ ] 히트맵 위젯 완성
- [ ] 차트 컴포넌트 구현
- [ ] AdMob 광고 표시

## 📝 다음 단계
Phase 8: 배포 준비로 진행