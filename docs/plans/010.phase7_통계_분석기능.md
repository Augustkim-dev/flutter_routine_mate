# 010. Phase 7: í†µê³„ ë° ë¶„ì„ ê¸°ëŠ¥

## ğŸ“‹ ì‘ì—… ê°œìš”
**ëª©í‘œ**: ì‚¬ìš©ì í–‰ë™ ë¶„ì„ ë° í†µê³„ ëŒ€ì‹œë³´ë“œ êµ¬í˜„
**ì˜ˆìƒ ê¸°ê°„**: 2ì¼
**ìš°ì„ ìˆœìœ„**: P2 (Future Enhancement)

## ğŸ¯ ì‘ì—… ëª©í‘œ
1. Firebase Analytics ì—°ë™
2. ë¡œì»¬ í†µê³„ ë°ì´í„° ìˆ˜ì§‘
3. í†µê³„ ëŒ€ì‹œë³´ë“œ UI êµ¬í˜„
4. AdMob ê´‘ê³  ì—°ë™
5. ë°ì´í„° ì‹œê°í™” ì»´í¬ë„ŒíŠ¸

## ğŸ“‚ ìƒì„±í•  íŒŒì¼ êµ¬ì¡°
```
lib/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ analytics_service.dart
â”‚       â””â”€â”€ ad_service.dart
â””â”€â”€ features/
    â””â”€â”€ statistics/
        â”œâ”€â”€ data/
        â”‚   â”œâ”€â”€ models/
        â”‚   â”‚   â”œâ”€â”€ statistics_model.dart
        â”‚   â”‚   â””â”€â”€ streak_model.dart
        â”‚   â””â”€â”€ repositories/
        â”‚       â””â”€â”€ statistics_repository_impl.dart
        â”œâ”€â”€ domain/
        â”‚   â”œâ”€â”€ entities/
        â”‚   â”‚   â”œâ”€â”€ routine_statistics.dart
        â”‚   â”‚   â””â”€â”€ completion_heatmap.dart
        â”‚   â””â”€â”€ usecases/
        â”‚       â”œâ”€â”€ calculate_statistics_usecase.dart
        â”‚       â””â”€â”€ generate_heatmap_usecase.dart
        â””â”€â”€ presentation/
            â”œâ”€â”€ screens/
            â”‚   â”œâ”€â”€ statistics_screen.dart
            â”‚   â””â”€â”€ routine_detail_screen.dart
            â”œâ”€â”€ widgets/
            â”‚   â”œâ”€â”€ statistics_card.dart
            â”‚   â”œâ”€â”€ streak_indicator.dart
            â”‚   â”œâ”€â”€ completion_chart.dart
            â”‚   â”œâ”€â”€ weekly_heatmap.dart
            â”‚   â”œâ”€â”€ monthly_calendar.dart
            â”‚   â””â”€â”€ progress_ring.dart
            â””â”€â”€ providers/
                â””â”€â”€ statistics_provider.dart
```

## ğŸ”§ ìƒì„¸ êµ¬í˜„ ê³„íš

### 1. Firebase Analytics ì„¤ì •
```dart
// analytics_service.dart
import 'package:firebase_analytics/firebase_analytics.dart';
import 'package:firebase_analytics/observer.dart';

class AnalyticsService {
  static final FirebaseAnalytics _analytics = FirebaseAnalytics.instance;
  static final FirebaseAnalyticsObserver observer =
      FirebaseAnalyticsObserver(analytics: _analytics);

  // ì´ë²¤íŠ¸ ë¡œê¹… ë©”ì„œë“œ
  static Future<void> logRoutineAdded({
    required String routineId,
    required String scheduleType,
    int? iconIndex,
    int? colorIndex,
  }) async {
    await _analytics.logEvent(
      name: 'routine_added',
      parameters: {
        'routine_id': routineId,
        'schedule_type': scheduleType,
        'icon_index': iconIndex,
        'color_index': colorIndex,
        'timestamp': DateTime.now().toIso8601String(),
      },
    );
  }

  static Future<void> logRoutineCompleted({
    required String routineId,
    required String source, // 'app', 'widget', 'notification'
    int? currentStreak,
  }) async {
    await _analytics.logEvent(
      name: 'routine_completed',
      parameters: {
        'routine_id': routineId,
        'source': source,
        'current_streak': currentStreak,
        'time_of_day': DateTime.now().hour, // ì™„ë£Œ ì‹œê°„ëŒ€ ë¶„ì„
        'day_of_week': DateTime.now().weekday,
      },
    );
  }

  static Future<void> logStreakAchieved({
    required String routineId,
    required int streakDays,
  }) async {
    await _analytics.logEvent(
      name: 'streak_achieved',
      parameters: {
        'routine_id': routineId,
        'streak_days': streakDays,
        'achievement_type': _getAchievementType(streakDays),
      },
    );
  }

  static Future<void> logScreenView(String screenName) async {
    await _analytics.logScreenView(
      screenName: screenName,
      screenClass: '${screenName}Screen',
    );
  }

  static Future<void> setUserProperties({
    required int totalRoutines,
    required double avgCompletionRate,
    required String primaryUsageTime,
  }) async {
    await _analytics.setUserProperty(
      name: 'total_routines',
      value: totalRoutines.toString(),
    );
    await _analytics.setUserProperty(
      name: 'avg_completion_rate',
      value: avgCompletionRate.toStringAsFixed(0),
    );
    await _analytics.setUserProperty(
      name: 'primary_usage_time',
      value: primaryUsageTime,
    );
  }

  static String _getAchievementType(int days) {
    if (days >= 365) return 'legendary';
    if (days >= 100) return 'expert';
    if (days >= 30) return 'advanced';
    if (days >= 7) return 'intermediate';
    return 'beginner';
  }
}
```

### 2. í†µê³„ ë°ì´í„° ëª¨ë¸
```dart
// routine_statistics.dart
class RoutineStatistics {
  final String routineId;
  final String routineName;
  final int totalDays;
  final int completedDays;
  final double completionRate;
  final int currentStreak;
  final int bestStreak;
  final DateTime? lastCompletedAt;
  final Map<int, double> weeklyPattern; // ìš”ì¼ë³„ ì™„ë£Œìœ¨
  final Map<int, double> hourlyPattern; // ì‹œê°„ëŒ€ë³„ ì™„ë£Œ ë¶„í¬
  final List<CompletionTrend> monthlyTrend;

  double get weeklyCompletionRate {
    final lastWeek = DateTime.now().subtract(Duration(days: 7));
    // ìµœê·¼ 7ì¼ ì™„ë£Œìœ¨ ê³„ì‚°
  }

  String get mostProductiveDay {
    // ê°€ì¥ ì™„ë£Œìœ¨ì´ ë†’ì€ ìš”ì¼
  }

  String get mostProductiveTime {
    // ê°€ì¥ ìì£¼ ì™„ë£Œí•˜ëŠ” ì‹œê°„ëŒ€
  }
}

// completion_heatmap.dart
class CompletionHeatmap {
  final DateTime startDate;
  final DateTime endDate;
  final Map<DateTime, double> data; // ë‚ ì§œë³„ ì™„ë£Œìœ¨ (0.0 ~ 1.0)

  List<List<HeatmapCell>> getWeeklyGrid() {
    // ì£¼ë³„ ê·¸ë¦¬ë“œ ë°ì´í„° ìƒì„±
  }

  Color getColorForValue(double value) {
    // ê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜ (ê·¸ë¼ë°ì´ì…˜)
    if (value == 0) return Colors.grey[100]!;
    if (value < 0.25) return Colors.green[100]!;
    if (value < 0.5) return Colors.green[300]!;
    if (value < 0.75) return Colors.green[500]!;
    return Colors.green[700]!;
  }
}
```

### 3. í†µê³„ ëŒ€ì‹œë³´ë“œ UI
```dart
// statistics_screen.dart
class StatisticsScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final statistics = ref.watch(statisticsProvider);

    return Scaffold(
      appBar: AppBar(
        title: Text('í†µê³„'),
        actions: [
          PopupMenuButton<DateRange>(
            onSelected: (range) {
              ref.read(dateRangeProvider.notifier).state = range;
            },
            itemBuilder: (context) => [
              PopupMenuItem(value: DateRange.week, child: Text('ì£¼ê°„')),
              PopupMenuItem(value: DateRange.month, child: Text('ì›”ê°„')),
              PopupMenuItem(value: DateRange.year, child: Text('ì—°ê°„')),
              PopupMenuItem(value: DateRange.all, child: Text('ì „ì²´')),
            ],
          ),
        ],
      ),
      body: statistics.when(
        data: (stats) => CustomScrollView(
          slivers: [
            // ì „ì²´ ìš”ì•½ ì¹´ë“œ
            SliverToBoxAdapter(
              child: _buildSummaryCard(stats),
            ),

            // ì£¼ê°„ íˆíŠ¸ë§µ
            SliverToBoxAdapter(
              child: _buildWeeklyHeatmap(stats),
            ),

            // ë£¨í‹´ë³„ í†µê³„
            SliverList(
              delegate: SliverChildBuilderDelegate(
                (context, index) => _buildRoutineStatCard(stats.routines[index]),
                childCount: stats.routines.length,
              ),
            ),

            // AdMob ë°°ë„ˆ
            SliverToBoxAdapter(
              child: _buildAdBanner(),
            ),
          ],
        ),
        loading: () => Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(child: Text('ì˜¤ë¥˜ ë°œìƒ')),
      ),
    );
  }

  Widget _buildSummaryCard(OverallStatistics stats) {
    return Card(
      margin: EdgeInsets.all(16),
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            Text('ì „ì²´ ì™„ë£Œìœ¨', style: TextStyle(fontSize: 14, color: Colors.grey)),
            SizedBox(height: 8),
            CircularProgressIndicator(
              value: stats.overallCompletionRate,
              strokeWidth: 8,
              backgroundColor: Colors.grey[200],
              valueColor: AlwaysStoppedAnimation(Colors.green),
            ),
            SizedBox(height: 8),
            Text(
              '${(stats.overallCompletionRate * 100).toStringAsFixed(0)}%',
              style: TextStyle(fontSize: 32, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 16),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              children: [
                _buildStatItem('í™œì„± ë£¨í‹´', stats.activeRoutines.toString()),
                _buildStatItem('ì™„ë£Œ íšŸìˆ˜', stats.totalCompletions.toString()),
                _buildStatItem('ìµœê³  ì—°ì†', '${stats.bestStreak}ì¼'),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
```

### 4. íˆíŠ¸ë§µ ìœ„ì ¯
```dart
// weekly_heatmap.dart
class WeeklyHeatmap extends StatelessWidget {
  final List<RoutineCompletion> completions;
  final int weeks;

  const WeeklyHeatmap({
    required this.completions,
    this.weeks = 12,
  });

  @override
  Widget build(BuildContext context) {
    final heatmapData = _generateHeatmapData();

    return Card(
      margin: EdgeInsets.all(16),
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'ìµœê·¼ ${weeks}ì£¼ í™œë™',
              style: Theme.of(context).textTheme.titleMedium,
            ),
            SizedBox(height: 16),
            SingleChildScrollView(
              scrollDirection: Axis.horizontal,
              reverse: true,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // ìš”ì¼ ë¼ë²¨
                  Row(
                    children: [
                      SizedBox(width: 30),
                      ...List.generate(weeks, (index) => SizedBox(width: 20)),
                    ],
                  ),
                  // íˆíŠ¸ë§µ ê·¸ë¦¬ë“œ
                  ...List.generate(7, (dayIndex) {
                    return Row(
                      children: [
                        // ìš”ì¼ ë¼ë²¨
                        SizedBox(
                          width: 30,
                          child: Text(
                            _getDayLabel(dayIndex),
                            style: TextStyle(fontSize: 12),
                          ),
                        ),
                        // íˆíŠ¸ë§µ ì…€
                        ...List.generate(weeks, (weekIndex) {
                          final value = heatmapData[weekIndex][dayIndex];
                          return Container(
                            width: 18,
                            height: 18,
                            margin: EdgeInsets.all(1),
                            decoration: BoxDecoration(
                              color: _getColorForValue(value),
                              borderRadius: BorderRadius.circular(2),
                            ),
                          );
                        }),
                      ],
                    );
                  }),
                ],
              ),
            ),
            SizedBox(height: 16),
            // ë²”ë¡€
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text('ì ìŒ', style: TextStyle(fontSize: 12)),
                SizedBox(width: 8),
                ...List.generate(5, (index) {
                  return Container(
                    width: 16,
                    height: 16,
                    margin: EdgeInsets.symmetric(horizontal: 2),
                    decoration: BoxDecoration(
                      color: _getColorForValue(index / 4),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  );
                }),
                SizedBox(width: 8),
                Text('ë§ìŒ', style: TextStyle(fontSize: 12)),
              ],
            ),
          ],
        ),
      ),
    );
  }

  String _getDayLabel(int index) {
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
    return days[index];
  }

  Color _getColorForValue(double value) {
    if (value == 0) return Colors.grey[100]!;
    if (value < 0.25) return Colors.green[200]!;
    if (value < 0.5) return Colors.green[400]!;
    if (value < 0.75) return Colors.green[600]!;
    return Colors.green[800]!;
  }
}
```

### 5. ì™„ë£Œìœ¨ ì°¨íŠ¸
```dart
// completion_chart.dart
class CompletionChart extends StatelessWidget {
  final List<ChartData> data;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 200,
      padding: EdgeInsets.all(16),
      child: CustomPaint(
        painter: ChartPainter(data: data),
        child: Container(),
      ),
    );
  }
}

class ChartPainter extends CustomPainter {
  final List<ChartData> data;

  ChartPainter({required this.data});

  @override
  void paint(Canvas canvas, Size size) {
    // ì¶• ê·¸ë¦¬ê¸°
    final axisPaint = Paint()
      ..color = Colors.grey
      ..strokeWidth = 1;

    // Yì¶•
    canvas.drawLine(
      Offset(40, 0),
      Offset(40, size.height - 30),
      axisPaint,
    );

    // Xì¶•
    canvas.drawLine(
      Offset(40, size.height - 30),
      Offset(size.width, size.height - 30),
      axisPaint,
    );

    // ë°ì´í„° í¬ì¸íŠ¸ ê·¸ë¦¬ê¸°
    final linePaint = Paint()
      ..color = Colors.blue
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    final path = Path();
    for (int i = 0; i < data.length; i++) {
      final x = 40 + (size.width - 40) * (i / (data.length - 1));
      final y = (size.height - 30) * (1 - data[i].value);

      if (i == 0) {
        path.moveTo(x, y);
      } else {
        path.lineTo(x, y);
      }

      // ë°ì´í„° í¬ì¸íŠ¸ ì›
      canvas.drawCircle(
        Offset(x, y),
        4,
        Paint()..color = Colors.blue,
      );
    }

    canvas.drawPath(path, linePaint);
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}
```

### 6. AdMob ê´‘ê³  ì—°ë™
```dart
// ad_service.dart
import 'package:google_mobile_ads/google_mobile_ads.dart';

class AdService {
  static final AdService _instance = AdService._internal();
  factory AdService() => _instance;
  AdService._internal();

  static const String _bannerAdUnitId = Platform.isIOS
      ? 'ca-app-pub-xxxxx/xxxxx' // iOS ê´‘ê³  ë‹¨ìœ„ ID
      : 'ca-app-pub-xxxxx/xxxxx'; // Android ê´‘ê³  ë‹¨ìœ„ ID

  BannerAd? _bannerAd;
  bool _isBannerAdReady = false;

  Future<void> initialize() async {
    await MobileAds.instance.initialize();
    _loadBannerAd();
  }

  void _loadBannerAd() {
    _bannerAd = BannerAd(
      adUnitId: _bannerAdUnitId,
      size: AdSize.banner,
      request: AdRequest(),
      listener: BannerAdListener(
        onAdLoaded: (_) {
          _isBannerAdReady = true;
          AnalyticsService.logAdImpression(_bannerAdUnitId);
        },
        onAdFailedToLoad: (ad, error) {
          print('Failed to load banner ad: ${error.message}');
          _isBannerAdReady = false;
          ad.dispose();
        },
      ),
    );

    _bannerAd!.load();
  }

  Widget getBannerAdWidget() {
    if (_isBannerAdReady && _bannerAd != null) {
      return Container(
        alignment: Alignment.center,
        width: _bannerAd!.size.width.toDouble(),
        height: _bannerAd!.size.height.toDouble(),
        child: AdWidget(ad: _bannerAd!),
      );
    } else {
      return SizedBox.shrink();
    }
  }

  void dispose() {
    _bannerAd?.dispose();
  }
}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê³„íš
1. **í†µê³„ ê³„ì‚° í…ŒìŠ¤íŠ¸**
   - ì™„ë£Œìœ¨ ì •í™•ì„±
   - ìŠ¤íŠ¸ë¦­ ê³„ì‚°
   - ì‹œê°„ëŒ€ë³„ ë¶„ì„

2. **UI í…ŒìŠ¤íŠ¸**
   - ì°¨íŠ¸ ë Œë”ë§
   - íˆíŠ¸ë§µ í‘œì‹œ
   - ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ

3. **Analytics í…ŒìŠ¤íŠ¸**
   - ì´ë²¤íŠ¸ ì „ì†¡
   - íŒŒë¼ë¯¸í„° ê²€ì¦
   - ë””ë²„ê·¸ ë·° í™•ì¸

## âš ï¸ ì£¼ì˜ì‚¬í•­
1. **ì„±ëŠ¥ ê³ ë ¤**
   - ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ìµœì í™”
   - ì°¨íŠ¸ ë Œë”ë§ ì„±ëŠ¥
   - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

2. **ê´‘ê³  ì •ì±…**
   - AdMob ì •ì±… ì¤€ìˆ˜
   - ê´‘ê³  ë°°ì¹˜ ê°€ì´ë“œë¼ì¸
   - ì‚¬ìš©ì ê²½í—˜ ê³ ë ¤

3. **ê°œì¸ì •ë³´**
   - Analytics ë°ì´í„° ìµëª…í™”
   - GDPR/CCPA ì¤€ìˆ˜
   - ì˜µíŠ¸ì•„ì›ƒ ì˜µì…˜

## ğŸ¯ ì™„ë£Œ ê¸°ì¤€
- [ ] Firebase Analytics ì—°ë™
- [ ] í†µê³„ ëŒ€ì‹œë³´ë“œ êµ¬í˜„
- [ ] íˆíŠ¸ë§µ ìœ„ì ¯ ì™„ì„±
- [ ] ì°¨íŠ¸ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
- [ ] AdMob ê´‘ê³  í‘œì‹œ

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„
Phase 8: ë°°í¬ ì¤€ë¹„ë¡œ ì§„í–‰